AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Heading Checker - AWS SAM Application

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs20.x
    MemorySize: 512
    Environment:
      Variables:
        NODE_ENV: production

Resources:
  # Lambda Function for Heading Analysis
  HeadingAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: dist/index.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Events:
        AnalyzeHeading:
          Type: Api
          Properties:
            Path: /analyze
            Method: post
            RestApiId: !Ref HeadingCheckerApi
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: '*'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - src/index.ts

  # API Gateway
  HeadingCheckerApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      DefinitionBody:
        openapi: 3.0.1
        info:
          title: Heading Checker API
          version: 1.0.0
        paths:
          /analyze:
            options:
              summary: CORS preflight support
              responses:
                '200':
                  description: Default CORS response
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: string
                    Access-Control-Allow-Methods:
                      schema:
                        type: string
                    Access-Control-Allow-Headers:
                      schema:
                        type: string
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: '200'
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
            post:
              summary: Analyze heading structure
              requestBody:
                required: true
                content:
                  application/json:
                    schema:
                      type: object
                      properties:
                        url:
                          type: string
                      required:
                        - url
              responses:
                '200':
                  description: Successful analysis
                  content:
                    application/json:
                      schema:
                        type: object
                '400':
                  description: Bad request
                '500':
                  description: Internal server error
              x-amazon-apigateway-integration:
                uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HeadingAnalyzerFunction.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

  # S3 Bucket for Static Website
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-frontend-${AWS::AccountId}
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  # S3 Bucket Policy
  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: s3:GetObject
            Resource: !Sub ${FrontendBucket.Arn}/*

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub https://${HeadingCheckerApi}.execute-api.${AWS::Region}.amazonaws.com/prod

  FrontendBucketName:
    Description: S3 bucket name for frontend
    Value: !Ref FrontendBucket

  WebsiteURL:
    Description: Static website URL
    Value: !GetAtt FrontendBucket.WebsiteURL

  FunctionArn:
    Description: Lambda Function ARN
    Value: !GetAtt HeadingAnalyzerFunction.Arn
